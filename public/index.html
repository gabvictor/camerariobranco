<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Câmeras ao Vivo - Rio Branco</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { width: 48px; height: 48px; border: 5px solid; border-color: #4F46E5 transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .favorite-btn .lucide-star { transition: all 0.2s ease-in-out; }
        .favorite-btn.is-favorite .lucide-star { fill: #facc15; color: #facc15; }
        .filter-btn { background-color: #E5E7EB; padding: 0.5rem 1rem; font-size: 0.875rem; border-radius: 0.375rem; transition: all 0.2s; white-space: nowrap; }
        .dark .filter-btn { background-color: #374151; }
        .filter-btn.active-filter { background-color: #4f46e5; color: white; font-weight: 600; box-shadow: 0 1px 3px 0 rgba(0,0,0,.1), 0 1px 2px -1px rgba(0,0,0,.1); }
        #update-progress-bar-container { position: fixed; top: 0; left: 0; width: 100%; height: 4px; z-index: 9999; background-color: transparent; }
        #update-progress-bar { height: 100%; background-color: #4f46e5; width: 0%; }
        #content-wrapper { display: none; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">
    
    <div id="content-wrapper">
        <div id="update-progress-bar-container"><div id="update-progress-bar"></div></div>
        <div id="camera-modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden flex items-center justify-center p-4 md:p-6 transition-opacity duration-300">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-full max-w-7xl max-h-[95vh] relative transform scale-95 transition-transform duration-300 grid grid-rows-[auto_1fr]">
                <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                    <h3 id="modal-title" class="text-lg font-semibold">Câmera</h3>
                    <button id="close-modal" aria-label="Fechar modal" class="p-2 -mr-2 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 dark:hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div class="relative min-h-0 p-4 bg-black/10 dark:bg-black/20 flex items-center justify-center">
                    <img id="modal-camera-feed" src="" alt="Visualização da Câmera" class="max-w-full max-h-full object-contain bg-black rounded-md">
                    <div id="modal-loader" class="absolute"><div class="loader"></div></div>
                    <button id="modal-prev" aria-label="Câmera anterior" class="absolute left-6 md:left-8 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 transition-opacity disabled:opacity-25 disabled:cursor-not-allowed"><i data-lucide="chevron-left" class="w-8 h-8"></i></button>
                    <button id="modal-next" aria-label="Próxima câmera" class="absolute right-6 md:right-8 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 transition-opacity disabled:opacity-25 disabled:cursor-not-allowed"><i data-lucide="chevron-right" class="w-8 h-8"></i></button>
                </div>
            </div>
        </div>
        <div class="container mx-auto px-4 py-8">
            <header class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Câmeras de Rio Branco</h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-1">Bem-vindo(a), <span id="username-display" class="font-semibold"></span>!</p>
                </div>
                <div class="flex items-center gap-2 sm:gap-4">
                    <span id="last-updated" class="text-sm text-gray-500 whitespace-nowrap"></span>
                    <a href="/mapa.html" title="Ver no mapa" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="map" class="w-5 h-5"></i></a>
                    <a id="dashboard-link" href="/dashboard.html" title="Dashboard" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 hidden">
                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    </a>
                    <button id="toggle-theme" title="Alternar tema" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="sun" class="w-5 h-5 block dark:hidden"></i><i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i></button>
                    <button id="logout-btn" title="Sair" class="p-2 rounded-full text-red-500 hover:bg-red-100 dark:hover:bg-red-900/50"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                </div>
            </header>
            <div class="mb-6 p-4 bg-white dark:bg-gray-800 rounded-lg shadow-sm space-y-4">
                <div class="relative"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none"></i><input type="text" id="search-input" placeholder="Buscar por nome da câmera..." class="w-full pl-10 pr-4 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 focus:outline-none"></div>
                <div id="filters-container" class="space-y-3">
                    <div class="flex flex-wrap items-center gap-x-4 gap-y-2"><span class="font-semibold text-sm">Status:</span><div id="status-filters" class="flex flex-wrap gap-2"><button data-filter-group="status" data-filter="online" class="filter-btn active-filter">Online (<span id="count-online">0</span>)</button><button data-filter-group="status" data-filter="all" class="filter-btn">Todas (<span id="count-all">0</span>)</button><button data-filter-group="status" data-filter="offline" class="filter-btn">Offline (<span id="count-offline">0</span>)</button><button data-filter-group="status" data-filter="favorites" class="filter-btn">Favoritas (<span id="count-favorites">0</span>)</button></div></div>
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-3">
                        <button id="category-toggle-btn" class="flex items-center justify-between w-full text-left font-semibold text-sm py-1"><span>Categorias</span><i data-lucide="chevron-down" id="category-toggle-icon" class="w-5 h-5 transition-transform"></i></button>
                        <div id="category-filters-container" class="mt-2 hidden"><div id="category-filters" class="flex flex-wrap gap-2"></div></div>
                    </div>
                </div>
            </div>
            <main id="camera-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 min-h-[500px]"></main>
            <div id="initial-loader" class="text-center py-20"><div class="loader mx-auto"></div><p class="mt-4 text-gray-500">A carregar câmaras...</p></div>
            <div id="no-results" class="text-center py-20 hidden col-span-full"><i data-lucide="camera-off" class="w-16 h-16 mx-auto mb-4 text-gray-400"></i><p class="text-gray-500">Nenhuma câmara encontrada.</p></div>
            <div id="pagination-controls" class="flex justify-center items-center mt-8 space-x-2"></div>
            <footer class="text-center mt-12 text-sm text-gray-500">
                <p>🔗 Projeto experimental - Câmaras Rio Branco</p>
                <a id="admin-link" href="/admin.html" class="hover:underline mt-2 hidden">Admin</a>
            </footer>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCQgDMwDnVbjhWdw6MYP1K754TAAsdhsy0",
            authDomain: "camerasriobranco.firebaseapp.com",
            projectId: "camerasriobranco",
            storageBucket: "camerasriobranco.appspot.com",
            messagingSenderId: "84020805734",
            appId: "1:84020805734:web:9904063112bd0b649f2da7",
            measurementId: "G-Y6B72KFF66"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const ADMIN_EMAIL = "vgabvictor@gmail.com";

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('content-wrapper').style.display = 'block';
                document.getElementById('username-display').textContent = user.displayName || user.email;

                if (user.email === ADMIN_EMAIL) {
                    document.getElementById('admin-link').style.display = 'inline-block';
                    document.getElementById('dashboard-link').classList.remove('hidden');
                }

                initializeAppLogic();
            } else {
                window.location.href = '/login.html';
            }
        });

        function initializeAppLogic() {
            const elements = {
                cameraGrid: document.getElementById('camera-grid'), searchInput: document.getElementById('search-input'), initialLoader: document.getElementById('initial-loader'), noResults: document.getElementById('no-results'), countAll: document.getElementById('count-all'), countOnline: document.getElementById('count-online'), countOffline: document.getElementById('count-offline'), countFavorites: document.getElementById('count-favorites'), lastUpdatedSpan: document.getElementById('last-updated'), themeToggleButton: document.getElementById('toggle-theme'), logoutBtn: document.getElementById('logout-btn'), modal: document.getElementById('camera-modal'), closeModalButton: document.getElementById('close-modal'), modalTitle: document.getElementById('modal-title'), modalCameraFeed: document.getElementById('modal-camera-feed'), modalLoader: document.getElementById('modal-loader'), modalPrevButton: document.getElementById('modal-prev'), modalNextButton: document.getElementById('modal-next'), paginationControls: document.getElementById('pagination-controls'), updateProgressBar: document.getElementById('update-progress-bar'), categoryToggleBtn: document.getElementById('category-toggle-btn'), categoryToggleIcon: document.getElementById('category-toggle-icon'), categoryFiltersContainer: document.getElementById('category-filters-container'),
            };
            let state = {
                allCameras: [], favorites: JSON.parse(localStorage.getItem('favoriteCameras')) || [], filteredCameras: [], currentSearch: '', currentStatusFilter: 'online', currentCategoryFilter: 'all', updateInterval: 2 * 60 * 1000, modalUpdateInterval: null, currentModalIndex: -1, currentPage: 1, itemsPerPage: 20,
            };
            const createCameraCard = (camera) => {
                const card = document.createElement('div');
                card.className = `camera-card flex flex-col bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden transition-transform duration-300 transform md:hover:-translate-y-1`;
                card.dataset.codigo = camera.codigo; card.dataset.status = camera.status;
                const isOnline = camera.status === 'online';
                const isFavorite = state.favorites.includes(camera.codigo);
                const imageUrl = isOnline ? `/proxy/camera?code=${camera.codigo}` : `https://placehold.co/400x300/e0e0e0/757575?text=Offline`;
                card.innerHTML = `<div class="relative group"><div class="aspect-video w-full bg-gray-200 dark:bg-gray-700 ${isOnline ? 'cursor-pointer' : ''}"><img src="${imageUrl}" alt="Câmara ${camera.nome}" class="w-full h-full object-cover" loading="lazy"></div><div class="absolute top-2 right-2 flex flex-col gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button title="Favoritar" class="favorite-btn ${isFavorite ? 'is-favorite' : ''} bg-black/50 p-2 rounded-full text-white hover:bg-black/75"><i data-lucide="star" class="w-5 h-5 pointer-events-none"></i></button><a href="/camera.html?code=${camera.codigo}" title="Abrir em nova aba" class="bg-black/50 p-2 rounded-full text-white hover:bg-black/75"><i data-lucide="external-link" class="w-5 h-5 pointer-events-none"></i></a></div></div><div class="p-3 flex-grow flex flex-col justify-center"><span class="font-semibold text-sm pr-2 truncate" title="${camera.nome}">${camera.nome}</span><div class="flex justify-between items-center mt-2"><span class="text-xs text-gray-500 dark:text-gray-400 truncate" title="${camera.categoria}">${camera.categoria}</span><span class="status-badge px-2 py-0.5 text-xs font-medium rounded-full ${isOnline ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300'}">${isOnline ? 'Online' : 'Offline'}</span></div></div>`;
                if (isOnline) card.querySelector('.aspect-video').addEventListener('click', () => openModal(camera.codigo));
                card.querySelector('.favorite-btn').addEventListener('click', (e) => { e.stopPropagation(); toggleFavorite(camera.codigo, e.currentTarget); });
                return card;
            };
            const toggleFavorite = (code, button) => {
                const index = state.favorites.indexOf(code);
                if (index > -1) state.favorites.splice(index, 1); else state.favorites.push(code);
                localStorage.setItem('favoriteCameras', JSON.stringify(state.favorites));
                button.classList.toggle('is-favorite');
                updateCounts();
                if (state.currentStatusFilter === 'favorites') applyFilters();
            };
            const renderCurrentPage = () => {
                elements.cameraGrid.innerHTML = '';
                elements.noResults.classList.add('hidden');
                const start = (state.currentPage - 1) * state.itemsPerPage;
                const end = start + state.itemsPerPage;
                const pageItems = state.filteredCameras.slice(start, end);
                if (pageItems.length === 0 && state.filteredCameras.length > 0) { state.currentPage = 1; renderCurrentPage(); return; }
                if (pageItems.length === 0) { elements.noResults.classList.remove('hidden'); } else { const fragment = document.createDocumentFragment(); pageItems.forEach(camera => fragment.appendChild(createCameraCard(camera))); elements.cameraGrid.appendChild(fragment); }
                lucide.createIcons();
                renderPaginationControls();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            const renderPaginationControls = () => {
                elements.paginationControls.innerHTML = '';
                const totalPages = Math.ceil(state.filteredCameras.length / state.itemsPerPage);
                if (totalPages <= 1) return;
                const createButton = (text, page, isDisabled = false, isActive = false) => {
                    const button = document.createElement('button');
                    button.innerHTML = text;
                    button.disabled = isDisabled;
                    button.className = `px-3 py-1 rounded-md text-sm font-medium transition-colors ${isActive ? 'bg-indigo-600 text-white cursor-default' : 'bg-white dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600'} ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}`;
                    if (!isDisabled && !isActive) { button.addEventListener('click', () => { state.currentPage = page; renderCurrentPage(); }); }
                    return button;
                };
                elements.paginationControls.appendChild(createButton('&laquo;', state.currentPage - 1, state.currentPage === 1));
                let startPage = Math.max(1, state.currentPage - 1), endPage = Math.min(totalPages, state.currentPage + 1);
                if (startPage > 1) { elements.paginationControls.appendChild(createButton('1', 1)); if (startPage > 2) { elements.paginationControls.appendChild(createButton('...', -1, true)); } }
                for (let i = startPage; i <= endPage; i++) { elements.paginationControls.appendChild(createButton(i, i, false, i === state.currentPage)); }
                if (endPage < totalPages) { if (endPage < totalPages - 1) { elements.paginationControls.appendChild(createButton('...', -1, true)); } elements.paginationControls.appendChild(createButton(totalPages, totalPages)); }
                elements.paginationControls.appendChild(createButton('&raquo;', state.currentPage + 1, state.currentPage === totalPages));
            };
            const applyFilters = () => {
                let filtered = state.allCameras;
                if (state.currentStatusFilter === 'favorites') { filtered = filtered.filter(cam => state.favorites.includes(cam.codigo)); } else if (state.currentStatusFilter !== 'all') { filtered = filtered.filter(cam => cam.status === state.currentStatusFilter); }
                if(state.currentCategoryFilter !== 'all') { filtered = filtered.filter(cam => cam.categoria === state.currentCategoryFilter); }
                if (state.currentSearch) { const searchTerm = state.currentSearch.toLowerCase(); filtered = filtered.filter(cam => cam.nome.toLowerCase().includes(searchTerm) || cam.codigo.includes(searchTerm)); }
                state.filteredCameras = filtered; state.currentPage = 1; renderCurrentPage();
            };
            const processDataUpdate = (data) => {
                state.allCameras = data;
                elements.initialLoader.classList.add('hidden');
                elements.cameraGrid.classList.remove('min-h-[500px]');
                updateCounts();
                updateCategoryFilters();
                applyFilters();
                elements.lastUpdatedSpan.textContent = `Atualizado às ${new Date().toLocaleTimeString('pt-BR')}`;
            };
            const fetchCameraStatus = async () => {
                try {
                    const response = await fetch('/status-cameras');
                    if (!response.ok) throw new Error('Network response was not ok');
                    processDataUpdate(await response.json());
                } catch (error) { console.error('Error loading status:', error); elements.initialLoader.innerHTML = '<p class="text-red-500">Failed to load cameras. Retrying...</p>'; }
            };
            const updateCounts = () => {
                const onlineCount = state.allCameras.filter(c => c.status === 'online').length;
                elements.countAll.textContent = state.allCameras.length;
                elements.countOnline.textContent = onlineCount;
                elements.countOffline.textContent = state.allCameras.length - onlineCount;
                elements.countFavorites.textContent = state.favorites.length;
            };
            const updateCategoryFilters = () => {
                const categories = [...new Set(state.allCameras.map(c => c.categoria))].filter(Boolean).sort();
                const categoryFilters = document.getElementById('category-filters');
                categoryFilters.innerHTML = '';
                const createFilterButton = (name, filter, count) => {
                    const button = document.createElement('button');
                    button.dataset.filterGroup = 'category'; button.dataset.filter = filter; button.className = 'filter-btn'; button.textContent = count ? `${name} (${count})` : name;
                    if (state.currentCategoryFilter === filter) { button.classList.add('active-filter'); }
                    return button;
                };
                categoryFilters.appendChild(createFilterButton('Todas', 'all'));
                categories.forEach(cat => { const count = state.allCameras.filter(c => c.categoria === cat).length; categoryFilters.appendChild(createFilterButton(cat, cat, count)); });
            };
            const initListeners = () => {
                elements.searchInput.addEventListener('input', e => { state.currentSearch = e.target.value; applyFilters(); });
                document.getElementById('filters-container').addEventListener('click', e => {
                    const button = e.target.closest('.filter-btn');
                    if (!button) return;
                    const { filterGroup, filter } = button.dataset;
                    if (filterGroup === 'status') state.currentStatusFilter = filter;
                    if (filterGroup === 'category') state.currentCategoryFilter = filter;
                    document.querySelectorAll(`.filter-btn[data-filter-group="${filterGroup}"]`).forEach(btn => btn.classList.remove('active-filter'));
                    button.classList.add('active-filter');
                    applyFilters();
                });
                elements.themeToggleButton.addEventListener('click', () => { const isDark = document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', isDark ? 'dark' : 'light'); });
                elements.logoutBtn.addEventListener('click', () => { signOut(auth); });
                elements.categoryToggleBtn.addEventListener('click', () => { elements.categoryFiltersContainer.classList.toggle('hidden'); elements.categoryToggleIcon.classList.toggle('rotate-180'); });
                elements.closeModalButton.addEventListener('click', closeModal);
                elements.modal.addEventListener('click', (e) => e.target === elements.modal && closeModal());
                elements.modalPrevButton.addEventListener('click', (e) => { e.stopPropagation(); navigateModal(-1); });
                elements.modalNextButton.addEventListener('click', (e) => { e.stopPropagation(); navigateModal(1); });
                document.addEventListener('keydown', (e) => { if (elements.modal.classList.contains('hidden')) return; if (e.key === 'Escape') closeModal(); if (e.key === 'ArrowLeft') navigateModal(-1); if (e.key === 'ArrowRight') navigateModal(1); });
            };
            const startUpdateIndicator = (duration) => {
                elements.updateProgressBar.style.transition = 'none';
                elements.updateProgressBar.style.width = '0%';
                requestAnimationFrame(() => { requestAnimationFrame(() => { elements.updateProgressBar.style.transition = `width ${duration / 1000}s linear`; elements.updateProgressBar.style.width = '100%'; }); });
            };
            const syncLoop = async () => {
                try { startUpdateIndicator(state.updateInterval); await fetchCameraStatus(); } catch (error) { console.error("Sync loop error:", error); } finally { setTimeout(syncLoop, state.updateInterval); }
            };
            const init = () => {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) { document.documentElement.classList.add('dark'); }
                lucide.createIcons();
                initListeners();
                syncLoop();
            };
            const getOnlineCamerasForModal = () => state.filteredCameras.filter(c => c.status === 'online');
            const openModal = (code) => {
                const onlineCameras = getOnlineCamerasForModal();
                state.currentModalIndex = onlineCameras.findIndex(c => c.codigo === code);
                if (state.currentModalIndex === -1) return;
                updateModalContent();
                elements.modal.classList.remove('hidden');
                setTimeout(() => { elements.modal.classList.add('opacity-100'); elements.modal.querySelector('.transform').classList.remove('scale-95'); }, 10);
                document.body.style.overflow = 'hidden';
            };
            const closeModal = () => {
                clearInterval(state.modalUpdateInterval);
                elements.modal.classList.remove('opacity-100');
                elements.modal.querySelector('.transform').classList.add('scale-95');
                setTimeout(() => elements.modal.classList.add('hidden'), 300);
                document.body.style.overflow = '';
            };
            const updateModalContent = () => {
                const onlineCameras = getOnlineCamerasForModal();
                if (state.currentModalIndex < 0 || state.currentModalIndex >= onlineCameras.length) return;
                const camera = onlineCameras[state.currentModalIndex];
                elements.modalTitle.textContent = camera.nome;
                elements.modalLoader.classList.remove('hidden');
                elements.modalCameraFeed.style.visibility = 'hidden';
                const updateFeed = () => { elements.modalCameraFeed.src = `/proxy/camera?code=${camera.codigo}&t=${Date.now()}`; };
                elements.modalCameraFeed.onload = () => { elements.modalLoader.classList.add('hidden'); elements.modalCameraFeed.style.visibility = 'visible'; };
                clearInterval(state.modalUpdateInterval);
                updateFeed();
                state.modalUpdateInterval = setInterval(updateFeed, 1500);
                elements.modalPrevButton.disabled = onlineCameras.length <= 1;
                elements.modalNextButton.disabled = onlineCameras.length <= 1;
            };
            const navigateModal = (direction) => {
                const onlineCameras = getOnlineCamerasForModal();
                const total = onlineCameras.length;
                if (total === 0) return;
                state.currentModalIndex = (state.currentModalIndex + direction + total) % total;
                updateModalContent();
            };
            init();
        }
    </script>
</body>
</html>

