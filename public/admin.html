<!DOCTYPE html>
<html lang="pt-br" class="">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://camerasriobranco.site/assets/icone.png" type="image/png">
    <link rel="apple-touch-icon" href="https://camerasriobranco.site/assets/icone.png">
    <title>Painel Administrativo Segura | Câmeras Rio Branco</title>
    <meta name="robots" content="noindex, nofollow">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="/script/theme.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .form-input {
            background-color: #F9FAFB;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #4F46E5;
            box-shadow: 0 0 0 1px #4F46E5;
        }

        .dark .form-input {
            background-color: #374151;
            border-color: #4B5563;
            color: #F9FAFB;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s, opacity 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: #4F46E5;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #4338CA;
        }

        .btn-secondary {
            background-color: #E5E7EB;
            color: #1F2937;
        }

        .dark .btn-secondary {
            background-color: #4B5563;
            color: #F9FAFB;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #D1D5DB;
        }

        .dark .btn-secondary:hover:not(:disabled) {
            background-color: #6B7280;
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid;
            border-color: #4F46E5 transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            z-index: 100;
            transition: bottom 0.5s ease-in-out;
            font-size: 0.9rem;
        }

        #toast.show {
            bottom: 30px;
        }

        #toast.success {
            background-color: #22c55e;
        }

        #toast.error {
            background-color: #ef4444;
        }

        #content-wrapper {
            display: none;
        }

        .skeleton-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .5;
            }
        }
    </style>
</head>

<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-200">

    <div id="access-denied" class="hidden min-h-screen flex flex-col items-center justify-center p-4 text-center">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-lg max-w-md w-full border border-gray-100 dark:border-gray-700">
            <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="lock" class="w-8 h-8 text-red-600 dark:text-red-400"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Acesso Restrito</h2>
            <p class="text-gray-600 dark:text-gray-400 mb-8">Esta área é exclusiva para administradores.</p>
            <div class="flex flex-col gap-3">
                <button id="login-trigger" class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-medium transition-colors shadow-lg shadow-indigo-600/20">
                    Fazer Login como Admin
                </button>
                <a href="/" class="py-3 px-4 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-xl font-medium transition-colors">
                    Voltar para Início
                </a>
            </div>
        </div>
    </div>

    <div id="content-wrapper">
        <div id="edit-modal"
            class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4 transition-opacity">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center gap-3">
                        <h2 id="modal-title" class="text-xl font-bold">Editar Câmera</h2>
                        <button id="refresh-preview-btn" title="Atualizar imagem"
                            class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                            <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <button id="close-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6 overflow-y-auto">
                    <div class="bg-black rounded-lg flex items-center justify-center min-h-[300px] relative"><img
                            id="modal-preview-img" src="" alt="Pré-visualização da câmera"
                            class="w-full h-full object-contain rounded-lg">
                        <div id="modal-loader" class="absolute">
                            <div class="loader"></div>
                        </div>
                    </div>
                    <div>
                        <form id="modal-form" class="space-y-4">
                            <input type="hidden" name="codigo">
                            <div><label class="font-semibold text-sm mb-1 block">Nome</label><input type="text"
                                    name="nome" class="form-input" required></div>
                            <div><label class="font-semibold text-sm mb-1 block">Categoria</label><input type="text"
                                    name="categoria" class="form-input"></div>
                            <div><label class="font-semibold text-sm mb-1 block">Descrição</label><textarea
                                    name="descricao" class="form-input" rows="3"></textarea></div>
                            <div><label class="font-semibold text-sm mb-1 block">Coordenadas (lat, lon)</label><input
                                    type="text" name="coords" class="form-input" placeholder="-9.9731, -67.8108"></div>
                            <div>
                                <label class="font-semibold text-sm mb-1 block">Nível de Permissão</label>
                                <select name="level" class="form-input">
                                    <option value="1">Nível 1 (Público)</option>
                                    <option value="3">Nível 3 (Privado)</option>
                                </select>
                            </div>
                            <div class="flex justify-end gap-3 pt-4"><button type="button" id="cancel-modal-btn"
                                    class="btn btn-secondary">Cancelar</button><button type="submit"
                                    class="btn btn-primary save-btn">Salvar Alterações</button></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="container mx-auto p-4 md:p-8">
            <header class="flex flex-wrap items-center justify-between gap-4 mb-8">
                <h1 class="text-3xl font-bold">Painel de Administração</h1>
                <div class="flex items-center gap-4">
                    <!-- App Banner Toggle -->
                    <label class="relative inline-flex items-center cursor-pointer mr-2" title="Habilitar/Desabilitar Banner do App">
                        <input type="checkbox" id="app-banner-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 dark:peer-focus:ring-indigo-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-indigo-600"></div>
                        <span class="ml-3 text-sm font-medium text-gray-900 dark:text-gray-300 hidden sm:inline">Banner App</span>
                    </label>

                    <button id="toggle-theme" title="Alternar tema"
                        class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="sun"
                            class="w-5 h-5 block dark:hidden"></i><i data-lucide="moon"
                            class="w-5 h-5 hidden dark:block"></i></button>
                <button id="nav-logout-btn" title="Sair"
                    class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
                <a href="/" title="Voltar à página inicial"
                        class="btn btn-secondary"><i data-lucide="arrow-left"
                            class="w-5 h-5 mr-2 -ml-1"></i><span>Voltar</span></a></div>
            </header>

            <!-- Status da IA Card -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-8">
                <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                    <div>
                        <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-2 flex items-center gap-2">
                            <i data-lucide="bot" class="w-6 h-6 text-indigo-600 dark:text-indigo-400"></i>
                            Status da Automação (IA)
                        </h2>
                        <div class="flex items-center gap-3">
                            <span id="ai-status-badge" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                                Carregando...
                            </span>
                            <span id="ai-next-run" class="text-sm text-gray-500 dark:text-gray-400 hidden">
                                Próxima análise em: -- min
                            </span>
                        </div>
                    </div>
                    <button id="toggle-ai-btn" class="w-full md:w-auto px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-xl font-bold transition-all hover:scale-105 active:scale-95 disabled:opacity-50 disabled:pointer-events-none flex items-center justify-center gap-2">
                        <span class="loader w-4 h-4 border-2 border-gray-500 border-t-transparent hidden" id="ai-btn-loader"></span>
                        <span id="ai-btn-text">Carregar Status</span>
                    </button>
                </div>
            </div>

            <div class="mb-6 flex flex-col sm:flex-row gap-4">
                <div class="relative flex-grow">
                    <i data-lucide="search"
                        class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none"></i>
                    <input type="text" id="search-input" placeholder="Buscar por nome ou código..."
                        class="form-input w-full pl-10">
                </div>
                <div class="flex-shrink-0">
                    <select id="filter-level-select" class="form-input w-full sm:w-auto">
                        <option value="all">Todos os Níveis</option>
                        <option value="1">Apenas Públicas</option>
                        <option value="3">Apenas Privadas</option>
                    </select>
                </div>
            </div>

            <div id="camera-list" class="space-y-4">
                <div class="text-center py-10">
                    <div class="loader mx-auto"></div>
                </div>
            </div>

            <footer class="mt-12 border-t border-gray-200 dark:border-gray-700 pt-6 pb-8">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex gap-4 text-sm font-medium text-gray-500 dark:text-gray-400">
                        <a href="/sobre" class="hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors">Sobre Nós</a>
                        <a href="/termos" class="hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors">Termos de Uso</a>
                        <a href="https://github.com/gabvictor/CamRB" target="_blank" class="hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors">GitHub</a>
                    </div>
                    <p class="text-xs text-gray-400">
                        &copy; 2025 CamRB.
                    </p>
                </div>
            </footer>
        </div>
        <div id="toast"></div>
    </div>

    <script type="module">
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { auth } from "/script/firebase-config.js";
        import { initAuthModal, toggleLoginModal, ADMIN_EMAIL } from "/script/auth-modal.js";

        // Initialize Auth Modal
        initAuthModal();

        // --- Configuração do Site (Banner App) ---
        const appBannerToggle = document.getElementById('app-banner-toggle');

        async function loadSiteConfig() {
            try {
                const res = await fetch('/api/site-config');
                const config = await res.json();
                if (appBannerToggle) {
                    appBannerToggle.checked = config.showAppBanner;
                }
            } catch (error) {
                console.error("Erro ao carregar config:", error);
            }
        }

        if (appBannerToggle) {
            appBannerToggle.addEventListener('change', async (e) => {
                const newValue = e.target.checked;
                const user = auth.currentUser;
                if (!user) {
                    alert("Você precisa estar logado.");
                    e.target.checked = !newValue; // Reverte
                    return;
                }

                try {
                    const token = await user.getIdToken();
                    const res = await fetch('/api/site-config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ showAppBanner: newValue })
                    });

                    if (!res.ok) throw new Error("Falha ao salvar");
                    
                    // Feedback visual (opcional)
                    const toast = document.getElementById('toast');
                    toast.textContent = "Configuração atualizada!";
                    toast.className = "show success";
                    setTimeout(() => toast.className = "", 3000);

                } catch (error) {
                    console.error("Erro ao atualizar config:", error);
                    alert("Erro ao salvar configuração.");
                    e.target.checked = !newValue; // Reverte
                }
            });
        }

        // Carregar config ao iniciar
        loadSiteConfig();

        const accessDeniedEl = document.getElementById('access-denied');
        const contentWrapperEl = document.getElementById('content-wrapper');
        const loginTriggerBtn = document.getElementById('login-trigger');
        const logoutBtn = document.getElementById('nav-logout-btn');

        if(loginTriggerBtn) {
            loginTriggerBtn.addEventListener('click', () => toggleLoginModal(true));
        }

        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                await signOut(auth);
                window.location.reload();
            });
        }

        onAuthStateChanged(auth, (user) => {
            if (user && user.email === ADMIN_EMAIL) {
                accessDeniedEl.classList.add('hidden');
                contentWrapperEl.style.display = 'block';
                initializeAdminLogic();
            } else {
                contentWrapperEl.style.display = 'none';
                accessDeniedEl.classList.remove('hidden');
                
                // If logged in but not admin, maybe show a different message?
                // For now, the generic "Restricted Access" is fine, but we shouldn't auto-trigger login modal if they are already logged in.
                if (!user) {
                    toggleLoginModal(true);
                } else {
                    // User is logged in but not admin.
                    // Update access denied text or just leave it.
                    const p = accessDeniedEl.querySelector('p');
                    if(p) p.textContent = `Acesso negado para ${user.email}. Esta área é exclusiva para administradores.`;
                    const btn = document.getElementById('login-trigger');
                    if(btn) btn.textContent = "Entrar com outra conta";
                }
            }
        });

        function initializeAdminLogic() {
            const elements = {
                cameraList: document.getElementById('camera-list'),
                themeToggleButton: document.getElementById('toggle-theme'),
                searchInput: document.getElementById('search-input'),
                filterLevelSelect: document.getElementById('filter-level-select'),
                modal: document.getElementById('edit-modal'),
                closeModalBtn: document.getElementById('close-modal-btn'),
                cancelModalBtn: document.getElementById('cancel-modal-btn'),
                modalForm: document.getElementById('modal-form'),
                modalPreviewImg: document.getElementById('modal-preview-img'),
                modalLoader: document.getElementById('modal-loader'),
                toast: document.getElementById('toast'),
                refreshPreviewBtn: document.getElementById('refresh-preview-btn'),
            };
            let allCameras = [];
            let previewInterval;
            let isPreviewLoading = false;

            // --- Auto AI Logic ---
            const aiStatusBadge = document.getElementById('ai-status-badge');
            const aiNextRun = document.getElementById('ai-next-run');
            const toggleAiBtn = document.getElementById('toggle-ai-btn');
            const aiBtnText = document.getElementById('ai-btn-text');
            const aiBtnLoader = document.getElementById('ai-btn-loader');
            
            const updateAiUi = (isActive, nextRunIn) => {
                if (!aiStatusBadge) return; // Se o elemento não existir
                
                if (isActive) {
                    aiStatusBadge.textContent = 'RODANDO';
                    aiStatusBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300';
                    
                    toggleAiBtn.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-200');
                    toggleAiBtn.classList.add('bg-red-600', 'text-white', 'hover:bg-red-700');
                    aiBtnText.textContent = 'Parar Automação';
                    
                    if (nextRunIn) {
                        aiNextRun.textContent = `Próxima análise em: ${nextRunIn}`;
                        aiNextRun.classList.remove('hidden');
                    } else {
                         aiNextRun.classList.remove('hidden');
                         aiNextRun.textContent = 'Próxima análise em: Calculando...';
                    }
                } else {
                    aiStatusBadge.textContent = 'PARADO';
                    aiStatusBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300';
                    
                    toggleAiBtn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-200');
                    toggleAiBtn.classList.remove('bg-red-600', 'text-white', 'hover:bg-red-700');
                    aiBtnText.textContent = 'Ativar Automação Hora em Hora';
                    
                    aiNextRun.classList.add('hidden');
                }
            };

            const loadAiStatus = async () => {
                try {
                    const user = auth.currentUser;
                    if(!user) return;
                    const idToken = await user.getIdToken();
                    
                    const res = await fetch('/api/ai/status', {
                         headers: { 'Authorization': `Bearer ${idToken}` }
                    });
                    const data = await res.json();
                    updateAiUi(data.active, data.nextRunIn);
                } catch (e) {
                    console.error("Erro ao carregar status IA", e);
                }
            };

            if (toggleAiBtn) {
                toggleAiBtn.addEventListener('click', async () => {
                    const user = auth.currentUser;
                    if (!user) return;
                    
                    aiBtnText.classList.add('hidden');
                    aiBtnLoader.classList.remove('hidden');
                    toggleAiBtn.disabled = true;

                    try {
                        const idToken = await user.getIdToken();
                        const res = await fetch('/api/ai/toggle-global', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${idToken}` }
                        });
                        const data = await res.json();
                        updateAiUi(data.active, data.nextRunIn);
                        showToast(data.active ? 'Automação ativada!' : 'Automação parada.');
                    } catch (error) {
                        showToast('Erro ao alterar status da IA', 'error');
                    } finally {
                        aiBtnText.classList.remove('hidden');
                        aiBtnLoader.classList.add('hidden');
                        toggleAiBtn.disabled = false;
                    }
                });
            }

            // Load status initially
            loadAiStatus();

            const showToast = (message, type = 'success') => {
                elements.toast.textContent = message; elements.toast.className = ``; elements.toast.classList.add(type, 'show');
                setTimeout(() => { elements.toast.classList.remove('show'); }, 3000);
            };
            elements.themeToggleButton.addEventListener('click', () => { if (window.toggleTheme) window.toggleTheme(); });

            const openEditModal = (camera) => {
                elements.modalForm.reset();
                elements.modalForm.elements.codigo.value = camera.codigo;
                elements.modalForm.elements.nome.value = camera.nome;
                elements.modalForm.elements.categoria.value = camera.categoria;
                elements.modalForm.elements.descricao.value = camera.descricao || '';
                elements.modalForm.elements.coords.value = camera.coords ? camera.coords.join(', ') : '';
                elements.modalForm.elements.level.value = camera.level || 1;
                elements.modal.classList.remove('hidden');
                lucide.createIcons();
                updatePreview(camera.codigo);
            };

            const closeEditModal = () => { elements.modal.classList.add('hidden'); clearInterval(previewInterval); elements.modalPreviewImg.src = ''; };

            const updatePreview = (code) => {
                clearInterval(previewInterval);
                let isFirstLoad = true;

                const update = () => {
                    if (isPreviewLoading) return;
                    isPreviewLoading = true;

                    if (isFirstLoad) {
                        elements.modalLoader.classList.remove('hidden');
                        elements.modalPreviewImg.style.display = 'none';
                    }

                    const tempImg = new Image();
                    // Adiciona o token na URL de preview também
                    const tokenParam = window.adminToken ? `&token=${window.adminToken}` : '';
                    const newSrc = `/proxy/camera/${code}?t=${Date.now()}${tokenParam}`;

                    tempImg.onload = () => {
                        elements.modalPreviewImg.src = newSrc;

                        if (isFirstLoad) {
                            elements.modalLoader.classList.add('hidden');
                            elements.modalPreviewImg.style.display = 'block';
                            isFirstLoad = false;
                        }
                        isPreviewLoading = false;
                    };

                    tempImg.onerror = () => {
                        elements.modalPreviewImg.src = '/assets/offline.png';
                        if (isFirstLoad) {
                            elements.modalLoader.classList.add('hidden');
                            elements.modalPreviewImg.style.display = 'block';
                            isFirstLoad = false;
                        }
                        isPreviewLoading = false;
                    };

                    tempImg.src = newSrc;
                };

                elements.refreshPreviewBtn.onclick = () => update();

                update();
                previewInterval = setInterval(update, 8000);
            };

            elements.closeModalBtn.addEventListener('click', closeEditModal);
            elements.cancelModalBtn.addEventListener('click', closeEditModal);

            const createCameraRow = (camera) => {
                const div = document.createElement('div');
                div.className = 'bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm flex items-center justify-between gap-4';

                const statusBadge = camera.status === 'online' ? `<span class="px-2 py-0.5 text-xs font-medium rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">Online</span>` : `<span class="px-2 py-0.5 text-xs font-medium rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">Offline</span>`;
                const levelText = camera.level === 3 ? ' (Privado)' : ' (Público)';

                const cacheBuster = Math.round(Date.now() / 15000) * 15000;
                // CORREÇÃO: Adiciona o token do admin para permitir visualização de câmeras privadas (nível 3)
                // O token é obtido de forma síncrona se já estiver carregado, ou pode ser passado como argumento.
                // Como createCameraRow é chamado após o loadCameras que verifica auth, o auth.currentUser deve estar disponível.
                // Mas para garantir o token atualizado, idealmente deveríamos pegar antes. 
                // Simplificação: vamos assumir que o usuário está logado e injetar um token global ou pegar via promise (mas src é string).
                // Solução: O script já tem o token no escopo se passarmos para createCameraRow ou usarmos uma variável global.
                
                // Vamos usar window.adminToken que definiremos no loadCameras
                const tokenParam = window.adminToken ? `&token=${window.adminToken}` : '';
                const imageUrl = `/proxy/camera/${camera.codigo}?t=${cacheBuster}${tokenParam}`;

                const lockIcon = camera.ai_locked ? 'lock' : 'lock-open';
                const lockColor = camera.ai_locked ? 'text-red-500 bg-red-50 dark:bg-red-900/20' : 'text-gray-400 bg-gray-100 dark:bg-gray-700 hover:text-gray-600 dark:hover:text-gray-200';
                const lockTitle = camera.ai_locked ? 'IA Bloqueada (Clique para desbloquear)' : 'IA Permitida (Clique para bloquear)';

                div.innerHTML = `
                    <div class="flex items-center gap-4 overflow-hidden">
                        <div class="w-24 h-16 rounded-md bg-gray-200 dark:bg-gray-700 flex-shrink-0 relative skeleton-pulse">
                            <img data-src="${imageUrl}" class="lazy-load w-full h-full object-cover rounded-md" alt="Câmera ${camera.codigo}">
                            <div class="absolute bottom-1 right-1">${statusBadge}</div>
                        </div>
                        <div class="overflow-hidden">
                            <p class="font-bold text-lg truncate flex items-center gap-2">
                                ${camera.nome}
                                <button class="lock-btn p-1 rounded-full ${lockColor} transition-colors" title="${lockTitle}">
                                    <i data-lucide="${lockIcon}" class="w-3 h-3"></i>
                                </button>
                            </p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${camera.codigo} &bull; ${camera.categoria}<span class="font-semibold">${levelText}</span></p>
                            <p class="text-xs text-gray-400 mt-1 italic description-text">${camera.descricao || 'Sem descrição'}</p>
                        </div>
                    </div>
                    <div class="flex-shrink-0 flex gap-2">
                        <button class="btn btn-secondary ai-btn" title="Gerar Descrição com IA" ${camera.ai_locked ? 'disabled' : ''}>
                            <i data-lucide="wand-2" class="w-4 h-4"></i>
                        </button>
                        <button class="btn btn-secondary edit-btn">
                            <i data-lucide="edit" class="w-4 h-4 sm:mr-2 -ml-1"></i>
                            <span class="hidden sm:inline">Editar</span>
                        </button>
                    </div>`;

                // Lock Button Logic
                const lockBtn = div.querySelector('.lock-btn');
                lockBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const newLockedState = !camera.ai_locked;
                    
                    // Optimistic UI update
                    // Re-create the <i> tag because Lucide replaces it with an <svg>
                    lockBtn.innerHTML = `<i data-lucide="${newLockedState ? 'lock' : 'lock-open'}" class="w-3 h-3"></i>`;
                    lockBtn.className = `lock-btn p-1 rounded-full ${newLockedState ? 'text-red-500 bg-red-50 dark:bg-red-900/20' : 'text-gray-400 bg-gray-100 dark:bg-gray-700 hover:text-gray-600 dark:hover:text-gray-200'} transition-colors`;
                    lucide.createIcons();

                    try {
                        const idToken = await auth.currentUser.getIdToken();
                        const res = await fetch(`/api/ai/toggle-lock/${camera.codigo}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${idToken}`
                            },
                            body: JSON.stringify({ locked: newLockedState })
                        });
                        
                        if (!res.ok) throw new Error('Falha ao atualizar bloqueio');
                        
                        const data = await res.json();
                        camera.ai_locked = data.ai_locked; // Update local model
                        showToast(data.message);
                        
                        // Update AI button state
                        const aiBtn = div.querySelector('.ai-btn');
                        if (aiBtn) aiBtn.disabled = camera.ai_locked;

                    } catch (error) {
                        console.error(error);
                        showToast('Erro ao atualizar bloqueio', 'error');
                        // Simple revert:
                        loadCameras(); 
                    }
                });

                div.querySelector('.edit-btn').addEventListener('click', () => openEditModal(camera));
                
                const aiBtn = div.querySelector('.ai-btn');
                aiBtn.addEventListener('click', async () => {
                    if (!confirm(`Deseja gerar uma descrição automática para a câmera ${camera.nome}?`)) return;
                    
                    const originalContent = aiBtn.innerHTML;
                    aiBtn.disabled = true;
                    aiBtn.innerHTML = `<div class="loader" style="width: 16px; height: 16px; border-width: 2px;"></div>`;
                    
                    try {
                        const idToken = await auth.currentUser.getIdToken();
                        const res = await fetch(`/api/ai/describe/${camera.codigo}`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${idToken}`
                            }
                        });
                        
                        const data = await res.json();
                        
                        if (res.ok) {
                            showToast('Descrição gerada com sucesso!');
                            // Atualiza o texto na interface
                            const descEl = div.querySelector('.description-text');
                            if (descEl) descEl.textContent = data.description;
                            // Atualiza o objeto local para persistir se re-renderizar (opcional, mas bom)
                            camera.descricao = data.description;
                        } else {
                            throw new Error(data.message || 'Erro ao gerar descrição');
                        }
                    } catch (error) {
                        console.error(error);
                        showToast(error.message, 'error');
                    } finally {
                        aiBtn.disabled = false;
                        aiBtn.innerHTML = originalContent;
                        lucide.createIcons();
                    }
                });

                return div;
            };

            const renderCameras = (cameras) => {
                elements.cameraList.innerHTML = '';
                if (cameras.length === 0) {
                    elements.cameraList.innerHTML = '<p class="text-gray-500 text-center">Nenhuma câmera encontrada para os filtros aplicados.</p>';
                    return;
                }
                const fragment = document.createDocumentFragment();
                cameras.forEach(camera => fragment.appendChild(createCameraRow(camera)));
                elements.cameraList.appendChild(fragment);
                lucide.createIcons();

                initializeLazyLoading();
            };

            const initializeLazyLoading = () => {
                const lazyImages = document.querySelectorAll('img.lazy-load');

                if ("IntersectionObserver" in window) {
                    const observer = new IntersectionObserver((entries, observer) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const img = entry.target;
                                const imgContainer = img.parentElement;

                                img.src = img.dataset.src;

                                img.onload = () => {
                                    img.classList.remove('lazy-load');
                                    imgContainer.classList.remove('skeleton-pulse');
                                };
                                img.onerror = () => {
                                    img.classList.remove('lazy-load');
                                    imgContainer.classList.remove('skeleton-pulse');
                                    img.alt = "Falha ao carregar";
                                };
                                observer.unobserve(img);
                            }
                        });
                    }, { rootMargin: "0px 0px 200px 0px" });

                    lazyImages.forEach(img => observer.observe(img));
                } else {
                    lazyImages.forEach(img => {
                        img.src = img.dataset.src;
                        img.parentElement.classList.remove('skeleton-pulse');
                    });
                }
            };

            const applyFilters = () => {
                const searchTerm = elements.searchInput.value.toLowerCase();
                const selectedLevel = elements.filterLevelSelect.value;

                let filteredCameras = allCameras;

                if (searchTerm) {
                    filteredCameras = filteredCameras.filter(camera =>
                        camera.nome.toLowerCase().includes(searchTerm) ||
                        camera.codigo.includes(searchTerm)
                    );
                }

                if (selectedLevel !== 'all') {
                    const level = parseInt(selectedLevel, 10);
                    if (level === 1) {
                        filteredCameras = filteredCameras.filter(camera => camera.level !== 3);
                    } else if (level === 3) {
                        filteredCameras = filteredCameras.filter(camera => camera.level === 3);
                    }
                }

                renderCameras(filteredCameras);
            };

            const loadCameras = async () => {
                try {
                    const user = auth.currentUser;
                    if (!user) throw new Error("Utilizador não autenticado.");

                    const idToken = await user.getIdToken();
                    window.adminToken = idToken; // Armazena o token globalmente para uso nas imagens

                    const response = await fetch('/status-cameras', {
                        headers: { 'Authorization': `Bearer ${idToken}` }
                    });
                    if (!response.ok) throw new Error("Falha ao buscar câmeras.");

                    allCameras = await response.json();
                    applyFilters();
                } catch (error) { elements.cameraList.innerHTML = `<p class="text-red-500 text-center">Não foi possível carregar as câmeras. ${error.message}</p>`; }
            };

            elements.searchInput.addEventListener('input', applyFilters);
            elements.filterLevelSelect.addEventListener('change', applyFilters);

            elements.modalForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) {
                    showToast('Sessão expirada. Por favor, faça login novamente.', 'error');
                    return;
                }

                const formData = new FormData(elements.modalForm);
                const coordsRaw = formData.get('coords').split(',').map(c => parseFloat(c.trim()));
                const data = {
                    codigo: formData.get('codigo'),
                    nome: formData.get('nome'),
                    categoria: formData.get('categoria'),
                    descricao: formData.get('descricao'),
                    coords: coordsRaw.length === 2 && !isNaN(coordsRaw[0]) && !isNaN(coordsRaw[1]) ? coordsRaw : null,
                    level: parseInt(formData.get('level'), 10)
                };

                const saveBtn = elements.modalForm.querySelector('.save-btn');
                const originalText = saveBtn.textContent;
                saveBtn.textContent = 'A Salvar...'; saveBtn.disabled = true;

                try {
                    const idToken = await user.getIdToken();
                    const response = await fetch('/api/update-camera-info', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}`
                        },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    if (!response.ok) { throw new Error(result.message || 'Falha ao salvar'); }
                    showToast(result.message, 'success');
                    await loadCameras();
                    closeEditModal();
                } catch (error) { showToast(error.message, 'error'); console.error(error); } finally { saveBtn.textContent = originalText; saveBtn.disabled = false; }
            });

            loadCameras();
            lucide.createIcons();
        }
    </script>
</body>

</html>